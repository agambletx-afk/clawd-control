<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Session Waterfall â€” Clawd Control</title>
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   WATERFALL â€” Page-specific styles
   Layout, sidebar, topbar, theme, design system
   provided by layout.js
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* â”€â”€ Page Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.page-header {
  margin-bottom: 24px;
}
.page-header h1 {
  font-size: 1.5rem; font-weight: 800; letter-spacing: -0.02em;
  display: flex; align-items: center; gap: 10px;
}
.page-header p {
  font-size: 0.82rem; color: var(--text-tertiary); margin-top: 4px;
}

/* â”€â”€ Controls Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.controls {
  display: flex; gap: 10px; align-items: center; flex-wrap: wrap;
  margin-bottom: 16px; padding: 12px 16px;
  background: var(--surface); border: 1px solid var(--border-subtle);
  border-radius: var(--radius-md);
}
.control-group { display: flex; align-items: center; gap: 6px; flex: 1; min-width: 200px; }
.control-label {
  font-size: 0.65rem; font-weight: 700; text-transform: uppercase;
  letter-spacing: 0.06em; color: var(--text-tertiary); white-space: nowrap;
}
.control-select {
  flex: 1; padding: 6px 10px; border-radius: var(--radius-sm);
  background: var(--bg-primary); border: 1px solid var(--border-subtle);
  color: var(--text-primary); font-family: var(--font-sans);
  font-size: 0.8rem; cursor: pointer; max-width: 300px;
}
.control-select:focus { border-color: var(--accent); outline: none; }

/* â”€â”€ Stats Grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.stats-grid {
  display: grid; grid-template-columns: repeat(5, 1fr);
  gap: 12px; margin-bottom: 16px;
}
.stat-card {
  background: var(--surface); border: 1px solid var(--border-subtle);
  border-radius: var(--radius-md); padding: 14px 16px;
  transition: all 0.35s ease;
}
.stat-card:hover { border-color: var(--border); }
[data-theme="light"] .stat-card { box-shadow: var(--shadow-sm); }
.stat-label {
  font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.06em;
  color: var(--text-tertiary); margin-bottom: 4px; font-weight: 600;
}
.stat-value {
  font-size: 1.5rem; font-weight: 800; line-height: 1;
  font-variant-numeric: tabular-nums;
}
.stat-value.accent { color: var(--accent); }
.stat-value.success { color: var(--success); }
.stat-value.info { color: var(--info); }
.stat-sub { font-size: 0.7rem; color: var(--text-tertiary); margin-top: 4px; }

/* â”€â”€ Waterfall Container â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.waterfall-card {
  background: var(--surface); border: 1px solid var(--border-subtle);
  border-radius: var(--radius-md); padding: 16px;
  margin-bottom: 12px;
}
.waterfall-card:hover { border-color: var(--border); }
[data-theme="light"] .waterfall-card { box-shadow: var(--shadow-sm); }

.waterfall-header {
  display: flex; justify-content: space-between; align-items: center;
  margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid var(--border-subtle);
}
.waterfall-title {
  font-size: 0.85rem; font-weight: 700; color: var(--text-primary);
  display: flex; align-items: center; gap: 6px;
}

/* â”€â”€ Waterfall Timeline â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.timeline {
  display: flex; flex-direction: column; gap: 4px; padding: 8px 0;
}

.timeline-item {
  position: relative; display: flex; align-items: stretch;
  min-height: 32px; border-radius: var(--radius-sm);
  transition: all 0.2s; cursor: pointer;
}
.timeline-item:hover { transform: translateX(4px); }

.timeline-marker {
  width: 80px; display: flex; flex-direction: column; justify-content: center;
  padding: 4px 8px; font-size: 0.7rem; color: var(--text-tertiary);
  border-right: 1px solid var(--border-subtle); flex-shrink: 0;
}
.timeline-time { font-variant-numeric: tabular-nums; font-weight: 600; }
.timeline-delta { font-size: 0.6rem; opacity: 0.6; }

.timeline-bar-container {
  flex: 1; display: flex; align-items: center; padding-left: 8px;
  position: relative;
}

.timeline-bar {
  height: 28px; border-radius: var(--radius-sm);
  display: flex; align-items: center; padding: 0 10px; gap: 6px;
  transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
  position: relative; min-width: 40px; max-width: 100%;
  box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}

.timeline-bar.user {
  background: linear-gradient(135deg, #3b82f6, #2563eb);
  color: white;
}
.timeline-bar.assistant {
  background: linear-gradient(135deg, #22c55e, #16a34a);
  color: white;
}
.timeline-bar.tool {
  background: linear-gradient(135deg, #c9a44a, #b8922f);
  color: var(--bg-primary);
}
.timeline-bar.thinking {
  background: linear-gradient(135deg, #8b5cf6, #7c3aed);
  color: white;
}
.timeline-bar.system {
  background: linear-gradient(135deg, #71717a, #52525b);
  color: white;
}

.timeline-icon {
  font-size: 0.9rem; flex-shrink: 0;
}

.timeline-label {
  font-size: 0.75rem; font-weight: 600; flex: 1;
  overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
}

.timeline-stats {
  display: flex; gap: 8px; font-size: 0.65rem; font-weight: 700;
  font-variant-numeric: tabular-nums; flex-shrink: 0;
  opacity: 0.9;
}

/* â”€â”€ Tool Call Nested Bars â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.timeline-tools {
  margin-left: 88px; margin-top: 2px; display: flex; flex-direction: column; gap: 2px;
}

.tool-bar {
  height: 20px; border-radius: var(--radius-sm);
  display: flex; align-items: center; padding: 0 8px; gap: 4px;
  background: rgba(201, 164, 74, 0.2);
  border-left: 3px solid var(--accent);
  font-size: 0.7rem; color: var(--text-secondary);
}

.tool-name {
  font-weight: 600; color: var(--accent);
}

/* â”€â”€ Detail Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.detail-panel {
  display: none; margin-top: 4px; margin-left: 88px;
  background: var(--bg-primary); border: 1px solid var(--border-subtle);
  border-radius: var(--radius-sm); padding: 12px;
  animation: slideDown 0.2s ease-out;
}
.detail-panel.open { display: block; }

@keyframes slideDown {
  from { opacity: 0; transform: translateY(-4px); }
  to { opacity: 1; transform: translateY(0); }
}

.detail-section {
  margin-bottom: 12px;
}
.detail-section:last-child { margin-bottom: 0; }

.detail-heading {
  font-size: 0.65rem; font-weight: 700; text-transform: uppercase;
  letter-spacing: 0.06em; color: var(--text-tertiary); margin-bottom: 6px;
}

.detail-text {
  font-size: 0.8rem; color: var(--text-secondary); line-height: 1.5;
  font-family: var(--font-mono); white-space: pre-wrap;
  background: var(--surface); padding: 8px; border-radius: var(--radius-sm);
  max-height: 200px; overflow-y: auto;
}

.detail-grid {
  display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;
}

.detail-item {
  background: var(--surface); padding: 8px; border-radius: var(--radius-sm);
}

.detail-item-label {
  font-size: 0.65rem; font-weight: 700; color: var(--text-tertiary);
  text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 2px;
}

.detail-item-value {
  font-size: 0.85rem; font-weight: 600; color: var(--text-primary);
  font-variant-numeric: tabular-nums;
}

/* â”€â”€ Filter Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.filter-bar {
  display: flex; gap: 6px; align-items: center; flex-wrap: wrap;
  margin-bottom: 12px;
}
.filter-pill {
  padding: 4px 12px; border-radius: 20px; border: 1px solid var(--border-subtle);
  background: transparent; color: var(--text-tertiary); cursor: pointer;
  font-size: 0.72rem; font-weight: 600; font-family: var(--font-sans);
  transition: all 0.2s; display: flex; align-items: center; gap: 4px;
}
.filter-pill:hover { border-color: var(--border); color: var(--text-secondary); }
.filter-pill.active { background: var(--accent); color: var(--bg-primary); border-color: var(--accent); }
.filter-pill .pill-count {
  background: rgba(255,255,255,.2); padding: 0 5px; border-radius: 10px;
  font-size: 0.6rem; font-weight: 700;
}
.filter-pill.active .pill-count { background: rgba(0,0,0,.2); }

.filter-search {
  flex: 1; min-width: 160px; max-width: 260px;
  padding: 5px 10px; border-radius: 20px;
  background: var(--bg-primary); border: 1px solid var(--border-subtle);
  color: var(--text-primary); font-family: var(--font-sans); font-size: 0.75rem;
  outline: none;
}
.filter-search:focus { border-color: var(--accent); }
.filter-search::placeholder { color: var(--text-tertiary); }

.filter-actions {
  display: flex; gap: 4px; margin-left: auto;
}
.filter-btn {
  padding: 4px 10px; border-radius: var(--radius-sm); border: 1px solid var(--border-subtle);
  background: transparent; color: var(--text-tertiary); cursor: pointer;
  font-size: 0.68rem; font-weight: 600; font-family: var(--font-sans);
  transition: all 0.2s;
}
.filter-btn:hover { border-color: var(--border); color: var(--text-secondary); }

/* â”€â”€ Duration Mini Chart (in stats) â”€â”€â”€â”€â”€â”€ */
.duration-breakdown {
  display: flex; gap: 2px; height: 6px; border-radius: 3px; overflow: hidden;
  margin-top: 6px;
}
.duration-seg { height: 100%; border-radius: 2px; transition: width 0.4s; }

/* â”€â”€ Gap Indicator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.timeline-gap {
  display: flex; align-items: center; justify-content: center;
  padding: 2px 0; margin-left: 80px; position: relative;
}
.timeline-gap::before {
  content: ''; position: absolute; left: 0; right: 0; top: 50%;
  border-top: 1px dashed var(--border-subtle);
}
.timeline-gap-label {
  background: var(--surface); padding: 0 8px; position: relative; z-index: 1;
  font-size: 0.6rem; color: var(--text-tertiary); font-weight: 600;
  font-variant-numeric: tabular-nums;
}

/* â”€â”€ Cost Heat Indicator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.timeline-bar.cost-high { box-shadow: 0 0 8px rgba(239, 68, 68, 0.4), 0 1px 3px rgba(0,0,0,0.2); }
.timeline-bar.cost-medium { box-shadow: 0 0 6px rgba(201, 164, 74, 0.3), 0 1px 3px rgba(0,0,0,0.2); }

/* â”€â”€ Hidden by filter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.timeline-entry.filtered-out { display: none; }

/* â”€â”€ Expand all detail panels â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.detail-panel.force-open { display: block; }

/* â”€â”€ Loading/Empty States â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.loading-state, .empty-state {
  text-align: center; padding: 40px 20px; color: var(--text-tertiary);
}
.loading-state .icon, .empty-state .icon { font-size: 2rem; margin-bottom: 12px; opacity: 0.4; }
.loading-state p, .empty-state p { font-size: 0.85rem; }

/* â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media (max-width: 900px) {
  .stats-grid { grid-template-columns: repeat(3, 1fr); }
  .timeline-marker { width: 60px; font-size: 0.65rem; }
  .timeline-tools { margin-left: 68px; }
  .detail-panel { margin-left: 68px; }
  .timeline-gap { margin-left: 60px; }
  .filter-bar { gap: 4px; }
}

@keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
.fade-up { animation: fadeUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) both; }
</style>
</head>
<body>

<main class="main">
  <div class="page-header fade-up">
    <h1>ğŸ“Š Session Waterfall</h1>
    <p>Timeline visualization of LLM calls, tool executions, and thinking blocks</p>
  </div>

  <div class="controls fade-up" style="animation-delay:.05s">
    <div class="control-group">
      <span class="control-label">Session</span>
      <select class="control-select" id="sessionSelect" onchange="loadSessionTrace()">
        <option value="">Loading sessions...</option>
      </select>
    </div>
  </div>

  <div class="stats-grid fade-up" style="animation-delay:.1s">
    <div class="stat-card">
      <div class="stat-label">Total Duration</div>
      <div class="stat-value info" id="statDuration">â€”</div>
      <div class="stat-sub" id="statDurationSub">Session length</div>
      <div class="duration-breakdown" id="durationBreakdown"></div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Total Cost</div>
      <div class="stat-value accent" id="statCost">â€”</div>
      <div class="stat-sub" id="statCostSub">API costs</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Total Tokens</div>
      <div class="stat-value success" id="statTokens">â€”</div>
      <div class="stat-sub" id="statTokensSub">All messages</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Messages</div>
      <div class="stat-value" style="color: var(--text-primary)" id="statMessages">â€”</div>
      <div class="stat-sub" id="statMessagesSub">Turns</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Cache Reads</div>
      <div class="stat-value" style="color: var(--accent)" id="statCache">â€”</div>
      <div class="stat-sub" id="statCacheSub">Cached tokens</div>
    </div>
  </div>

  <div class="waterfall-card fade-up" style="animation-delay:.15s">
    <div class="waterfall-header">
      <div class="waterfall-title">
        <i data-lucide="activity"></i>
        Timeline
      </div>
      <div id="timelineCount" style="font-size:0.72rem;color:var(--text-tertiary);font-variant-numeric:tabular-nums"></div>
    </div>
    <div id="filterBar" class="filter-bar" style="display:none">
      <button class="filter-pill active" data-filter="all" onclick="setFilter('all', this)">All</button>
      <button class="filter-pill" data-filter="user" onclick="setFilter('user', this)">ğŸ‘¤ User <span class="pill-count" id="countUser">0</span></button>
      <button class="filter-pill" data-filter="assistant" onclick="setFilter('assistant', this)">ğŸ¤– Assistant <span class="pill-count" id="countAssistant">0</span></button>
      <button class="filter-pill" data-filter="tool" onclick="setFilter('tool', this)">ğŸ› ï¸ Tools <span class="pill-count" id="countTool">0</span></button>
      <button class="filter-pill" data-filter="thinking" onclick="setFilter('thinking', this)">ğŸ¤” Thinking <span class="pill-count" id="countThinking">0</span></button>
      <input class="filter-search" id="searchInput" type="text" placeholder="Search messages..." oninput="applyFilters()">
      <div class="filter-actions">
        <button class="filter-btn" onclick="expandAll()" title="Expand all details">â†• Expand All</button>
        <button class="filter-btn" onclick="collapseAll()" title="Collapse all">â†• Collapse</button>
      </div>
    </div>
    <div id="timeline" class="timeline">
      <div class="loading-state">
        <div class="icon">â³</div>
        <p>Select a session to view the waterfall</p>
      </div>
    </div>
  </div>

</main>

<script src="/layout.js"></script>
<script>
'use strict';

const $ = s => document.querySelector(s);
let currentTrace = null;
let activeFilter = 'all';
let allExpanded = false;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

loadSessions();

// Keyboard navigation
document.addEventListener('keydown', (e) => {
  if (!currentTrace) return;
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;
  if (e.key === 'e') expandAll();
  if (e.key === 'c') collapseAll();
});

async function loadSessions() {
  try {
    const res = await fetch('/api/sessions?limit=100');
    const data = await res.json();
    const sessions = data.sessions || data; // handle both paginated and old format
    
    const select = $('#sessionSelect');
    if (!sessions || sessions.length === 0) {
      select.innerHTML = '<option value="">No sessions found</option>';
      return;
    }

    select.innerHTML = '<option value="">â€” Select a session â€”</option>' + 
      sessions.map(s => {
        const time = s.updatedAt ? timeAgo(s.updatedAt) : 'unknown';
        return `<option value="${escapeAttr(s.key)}">${escapeHtml(s.agentEmoji + ' ' + s.agentName + ' / ' + s.displayName)} (${time})</option>`;
      }).join('');

    // Auto-select from URL hash
    if (window.location.hash) {
      const key = decodeURIComponent(window.location.hash.slice(1));
      if (select.querySelector(`option[value="${CSS.escape(key)}"]`)) {
        select.value = key;
        loadSessionTrace();
      }
    }
  } catch (e) {
    console.error('Failed to load sessions:', e);
    if (typeof showToast === 'function') showToast('Failed to load sessions', 'error');
  }
}

async function loadSessionTrace() {
  const sessionKey = $('#sessionSelect').value;
  if (!sessionKey) { resetView(); return; }

  // Update URL hash for bookmarking
  window.location.hash = encodeURIComponent(sessionKey);

  try {
    const res = await fetch(`/api/session/${encodeURIComponent(sessionKey)}/trace`);
    if (!res.ok) {
      if (typeof showToast === 'function') showToast('Session not found', 'error');
      resetView();
      return;
    }
    currentTrace = await res.json();
    activeFilter = 'all';
    $('#searchInput').value = '';
    document.querySelectorAll('.filter-pill').forEach(p => p.classList.toggle('active', p.dataset.filter === 'all'));
    renderTrace();
  } catch (e) {
    console.error('Failed to load trace:', e);
    if (typeof showToast === 'function') showToast('Failed to load trace data', 'error');
    resetView();
  }
}

function resetView() {
  currentTrace = null;
  $('#statDuration').textContent = 'â€”';
  $('#statDurationSub').textContent = 'Session length';
  $('#statCost').textContent = 'â€”';
  $('#statCostSub').textContent = 'API costs';
  $('#statTokens').textContent = 'â€”';
  $('#statTokensSub').textContent = 'All messages';
  $('#statMessages').textContent = 'â€”';
  $('#statMessagesSub').textContent = 'Turns';
  $('#statCache').textContent = 'â€”';
  $('#statCacheSub').textContent = 'Cached tokens';
  $('#durationBreakdown').innerHTML = '';
  $('#filterBar').style.display = 'none';
  $('#timelineCount').textContent = '';
  $('#timeline').innerHTML = '<div class="loading-state"><div class="icon">â³</div><p>Select a session to view the waterfall</p></div>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FILTERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function setFilter(filter, btn) {
  activeFilter = filter;
  document.querySelectorAll('.filter-pill').forEach(p => p.classList.remove('active'));
  btn.classList.add('active');
  applyFilters();
}

function applyFilters() {
  const search = ($('#searchInput').value || '').toLowerCase();
  const entries = document.querySelectorAll('.timeline-entry');
  let visible = 0;

  entries.forEach(entry => {
    const type = entry.dataset.type;
    const text = (entry.dataset.text || '').toLowerCase();
    
    const matchesType = activeFilter === 'all' || type === activeFilter;
    const matchesSearch = !search || text.includes(search);
    
    entry.classList.toggle('filtered-out', !(matchesType && matchesSearch));
    if (matchesType && matchesSearch) visible++;
  });

  // Also hide gap indicators that are between two filtered-out entries
  document.querySelectorAll('.timeline-gap').forEach(gap => {
    const prev = gap.previousElementSibling;
    const next = gap.nextElementSibling;
    const prevHidden = prev && prev.classList.contains('filtered-out');
    const nextHidden = next && next.classList.contains('filtered-out');
    gap.style.display = (prevHidden || nextHidden) ? 'none' : '';
  });

  const total = entries.length;
  $('#timelineCount').textContent = visible < total ? `${visible} / ${total} shown` : `${total} messages`;
}

function expandAll() {
  if (!currentTrace) return;
  const entries = document.querySelectorAll('.timeline-entry:not(.filtered-out)');
  entries.forEach(entry => {
    const msg = currentTrace.trace[parseInt(entry.dataset.idx)];
    if (!msg) return;
    let panel = entry.querySelector('.detail-panel');
    if (!panel) {
      panel = buildDetailPanel(msg);
      entry.appendChild(panel);
    }
    panel.classList.add('open');
  });
  allExpanded = true;
}

function collapseAll() {
  document.querySelectorAll('.detail-panel').forEach(p => p.classList.remove('open'));
  allExpanded = false;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER TRACE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderTrace() {
  if (!currentTrace || !currentTrace.trace) { resetView(); return; }

  const { trace, summary } = currentTrace;

  // Stats
  $('#statDuration').textContent = formatDuration(summary.totalDuration);
  $('#statDurationSub').textContent = `${trace.length} messages`;

  $('#statCost').textContent = summary.totalCost > 0 ? `$${summary.totalCost.toFixed(4)}` : '$0.00';
  $('#statCostSub').textContent = 'Total API cost';

  $('#statTokens').textContent = formatNumber(summary.totalTokens);
  $('#statTokensSub').textContent = `${formatNumber(summary.totalInput)} in / ${formatNumber(summary.totalOutput)} out`;

  const userTurns = trace.filter(t => t.role === 'user').length;
  $('#statMessages').textContent = summary.messageCount;
  $('#statMessagesSub').textContent = userTurns + ' user turns';

  $('#statCache').textContent = formatNumber(summary.totalCacheRead);
  const cachePct = summary.totalTokens > 0 ? Math.round(summary.totalCacheRead / summary.totalTokens * 100) : 0;
  $('#statCacheSub').textContent = cachePct > 0 ? `${cachePct}% of total` : 'No cache hits';

  // Duration breakdown mini chart
  renderDurationBreakdown(trace);

  // Filter bar counts
  const counts = { user: 0, assistant: 0, tool: 0, thinking: 0 };
  trace.forEach(msg => {
    const type = getMsgType(msg);
    if (counts[type] !== undefined) counts[type]++;
  });
  Object.entries(counts).forEach(([k, v]) => {
    const el = $(`#count${k.charAt(0).toUpperCase() + k.slice(1)}`);
    if (el) el.textContent = v;
  });
  $('#filterBar').style.display = trace.length > 0 ? 'flex' : 'none';

  // Timeline
  if (trace.length === 0) {
    $('#timeline').innerHTML = '<div class="empty-state"><div class="icon">ğŸ“­</div><p>No messages in this session</p></div>';
    return;
  }

  const maxDuration = Math.max(...trace.map(t => t.duration || 0), 1);
  const maxCost = Math.max(...trace.map(t => t.cost || 0), 0.001);
  const timeline = $('#timeline');
  timeline.innerHTML = '';

  trace.forEach((msg, idx) => {
    // Insert gap indicator for pauses > 30 seconds
    if (idx > 0) {
      const prevTs = new Date(trace[idx - 1].timestamp).getTime();
      const thisTs = new Date(msg.timestamp).getTime();
      const gap = thisTs - prevTs;
      if (gap > 30000) {
        const gapEl = document.createElement('div');
        gapEl.className = 'timeline-gap';
        gapEl.innerHTML = `<span class="timeline-gap-label">â± ${formatDuration(gap)} gap</span>`;
        timeline.appendChild(gapEl);
      }
    }
    const item = createTimelineItem(msg, idx, maxDuration, maxCost);
    timeline.appendChild(item);
  });

  $('#timelineCount').textContent = `${trace.length} messages`;
  refreshIcons();
}

function getMsgType(msg) {
  if (msg.role === 'user') return 'user';
  if (msg.role === 'assistant') {
    if (msg.contentTypes.includes('toolCall')) return 'tool';
    if (msg.hasThinking) return 'thinking';
    return 'assistant';
  }
  return msg.role;
}

function renderDurationBreakdown(trace) {
  const container = $('#durationBreakdown');
  const totalDuration = trace.reduce((s, m) => s + (m.duration || 0), 0) || 1;
  
  // Aggregate duration by type
  const byType = { user: 0, assistant: 0, tool: 0, thinking: 0 };
  const colors = { user: '#3b82f6', assistant: '#22c55e', tool: '#c9a44a', thinking: '#8b5cf6' };
  
  trace.forEach(msg => {
    const type = getMsgType(msg);
    byType[type] = (byType[type] || 0) + (msg.duration || 0);
  });

  container.innerHTML = Object.entries(byType)
    .filter(([, v]) => v > 0)
    .map(([type, dur]) => {
      const pct = Math.max(2, dur / totalDuration * 100);
      return `<div class="duration-seg" style="width:${pct}%;background:${colors[type]}" title="${type}: ${formatDuration(dur)}"></div>`;
    }).join('');
}

function createTimelineItem(msg, idx, maxDuration, maxCost) {
  const container = document.createElement('div');
  container.className = 'timeline-entry';
  container.dataset.idx = idx;
  container.dataset.type = getMsgType(msg);
  container.dataset.text = (msg.textPreview || '') + ' ' + (msg.toolCalls || []).map(t => t.name).join(' ');

  let barType = msg.role;
  let icon = 'ğŸ’¬';
  let label = msg.role.charAt(0).toUpperCase() + msg.role.slice(1);

  if (msg.role === 'user') {
    icon = 'ğŸ‘¤'; label = 'User';
    if (msg.textPreview) label = truncate(msg.textPreview, 60);
  } else if (msg.role === 'assistant') {
    if (msg.contentTypes.includes('toolCall')) {
      barType = 'tool'; icon = 'ğŸ› ï¸';
      label = `${msg.toolCalls.length} tool call${msg.toolCalls.length > 1 ? 's' : ''}: ${(msg.toolCalls || []).map(t => t.name).join(', ')}`;
      label = truncate(label, 60);
    } else if (msg.hasThinking) {
      barType = 'thinking'; icon = 'ğŸ¤”'; label = 'Thinking + Response';
    } else {
      icon = 'ğŸ¤–';
      label = msg.textPreview ? truncate(msg.textPreview, 60) : 'Assistant';
    }
  }

  // Duration â†’ bar width
  const durationMs = msg.duration || 0;
  const widthPct = durationMs > 0 ? Math.min(95, Math.log(durationMs + 1) / Math.log(maxDuration + 1) * 90 + 5) : 5;

  // Cost heat indicator
  let costClass = '';
  if (msg.cost > 0 && maxCost > 0) {
    const costRatio = msg.cost / maxCost;
    if (costRatio > 0.6) costClass = 'cost-high';
    else if (costRatio > 0.3) costClass = 'cost-medium';
  }

  const time = new Date(msg.timestamp);
  const timeStr = time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
  const deltaStr = durationMs > 0 ? `+${formatDuration(durationMs)}` : '';

  const itemEl = document.createElement('div');
  itemEl.className = 'timeline-item';
  itemEl.innerHTML = `
    <div class="timeline-marker">
      <div class="timeline-time">${timeStr}</div>
      ${deltaStr ? `<div class="timeline-delta">${deltaStr}</div>` : ''}
    </div>
    <div class="timeline-bar-container">
      <div class="timeline-bar ${barType} ${costClass}" style="width: ${widthPct}%">
        <span class="timeline-icon">${icon}</span>
        <span class="timeline-label">${escapeHtml(label)}</span>
        <span class="timeline-stats">
          ${msg.usage.total > 0 ? `<span>${formatNumber(msg.usage.total)} tok</span>` : ''}
          ${msg.cost > 0 ? `<span>$${msg.cost.toFixed(4)}</span>` : ''}
        </span>
      </div>
    </div>
  `;

  itemEl.addEventListener('click', (e) => {
    if (e.target.closest('.tool-bar')) return;
    toggleDetails(container, msg);
  });

  container.appendChild(itemEl);

  // Tool call bars with clickable expansion
  if (msg.toolCalls && msg.toolCalls.length > 0) {
    const toolsEl = document.createElement('div');
    toolsEl.className = 'timeline-tools';
    msg.toolCalls.forEach((tool, ti) => {
      const toolBar = document.createElement('div');
      toolBar.className = 'tool-bar';
      toolBar.style.cursor = 'pointer';
      toolBar.innerHTML = `<span class="tool-name">${escapeHtml(tool.name)}</span><span style="font-size:0.6rem;color:var(--text-tertiary);margin-left:auto">â–¸ details</span>`;
      toolBar.addEventListener('click', (e) => {
        e.stopPropagation();
        // Toggle inline tool detail
        let det = toolBar.nextElementSibling;
        if (det && det.classList.contains('tool-detail-inline')) {
          det.remove();
          return;
        }
        det = document.createElement('div');
        det.className = 'tool-detail-inline';
        det.style.cssText = 'margin:2px 0 4px;padding:8px;background:var(--bg-primary);border:1px solid var(--border-subtle);border-radius:var(--radius-sm);font-size:0.75rem;font-family:var(--font-mono);white-space:pre-wrap;max-height:200px;overflow-y:auto;color:var(--text-secondary);';
        det.textContent = JSON.stringify(tool, null, 2);
        toolBar.after(det);
      });
      toolsEl.appendChild(toolBar);
    });
    container.appendChild(toolsEl);
  }

  return container;
}

function buildDetailPanel(msg) {
  const detailPanel = document.createElement('div');
  detailPanel.className = 'detail-panel';

  let html = '';

  if (msg.fullText) {
    html += `
      <div class="detail-section">
        <div class="detail-heading">Message Text</div>
        <div class="detail-text">${escapeHtml(msg.fullText)}</div>
      </div>
    `;
  }

  // Duration bar if available
  if (msg.duration > 0) {
    html += `
      <div class="detail-section">
        <div class="detail-heading">Timing</div>
        <div style="display:flex;align-items:center;gap:8px">
          <div style="flex:1;height:8px;background:var(--bg-secondary);border-radius:4px;overflow:hidden">
            <div style="height:100%;width:100%;background:var(--accent);border-radius:4px"></div>
          </div>
          <span style="font-size:0.8rem;font-weight:700;color:var(--text-primary);font-variant-numeric:tabular-nums">${formatDuration(msg.duration)}</span>
        </div>
      </div>
    `;
  }

  html += `
    <div class="detail-section">
      <div class="detail-heading">Token Usage & Cost</div>
      <div class="detail-grid">
        <div class="detail-item">
          <div class="detail-item-label">Input Tokens</div>
          <div class="detail-item-value">${formatNumber(msg.usage.input)}</div>
        </div>
        <div class="detail-item">
          <div class="detail-item-label">Output Tokens</div>
          <div class="detail-item-value">${formatNumber(msg.usage.output)}</div>
        </div>
        <div class="detail-item">
          <div class="detail-item-label">Cache Reads</div>
          <div class="detail-item-value">${formatNumber(msg.usage.cacheRead)}</div>
        </div>
        <div class="detail-item">
          <div class="detail-item-label">Cost</div>
          <div class="detail-item-value">$${msg.cost.toFixed(6)}</div>
        </div>
      </div>
    </div>
  `;

  html += `
    <div class="detail-section">
      <div class="detail-heading">Metadata</div>
      <div class="detail-grid">
        <div class="detail-item">
          <div class="detail-item-label">Model</div>
          <div class="detail-item-value">${escapeHtml(msg.model)}</div>
        </div>
        <div class="detail-item">
          <div class="detail-item-label">Stop Reason</div>
          <div class="detail-item-value">${escapeHtml(msg.stopReason || 'none')}</div>
        </div>
        <div class="detail-item">
          <div class="detail-item-label">Content Types</div>
          <div class="detail-item-value">${escapeHtml(msg.contentTypes.join(', ') || 'none')}</div>
        </div>
        <div class="detail-item">
          <div class="detail-item-label">Timestamp</div>
          <div class="detail-item-value" style="font-size: 0.7rem">${new Date(msg.timestamp).toLocaleString()}</div>
        </div>
      </div>
    </div>
  `;

  if (msg.toolCalls && msg.toolCalls.length > 0) {
    html += `
      <div class="detail-section">
        <div class="detail-heading">Tool Calls (${msg.toolCalls.length})</div>
        <div class="detail-text">${escapeHtml(JSON.stringify(msg.toolCalls, null, 2))}</div>
      </div>
    `;
  }

  detailPanel.innerHTML = html;
  return detailPanel;
}

function toggleDetails(container, msg) {
  let detailPanel = container.querySelector('.detail-panel');
  
  if (detailPanel) {
    detailPanel.classList.toggle('open');
    return;
  }

  detailPanel = buildDetailPanel(msg);
  detailPanel.classList.add('open');
  container.appendChild(detailPanel);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function formatDuration(ms) {
  if (ms < 1000) return `${ms}ms`;
  if (ms < 60000) return `${(ms / 1000).toFixed(1)}s`;
  if (ms < 3600000) return `${Math.floor(ms / 60000)}m ${Math.floor((ms % 60000) / 1000)}s`;
  const h = Math.floor(ms / 3600000);
  const m = Math.floor((ms % 3600000) / 60000);
  return `${h}h ${m}m`;
}

function formatNumber(n) {
  if (n > 1e6) return (n / 1e6).toFixed(1) + 'M';
  if (n > 1e3) return (n / 1e3).toFixed(1) + 'K';
  return n.toString();
}

function timeAgo(ts) {
  const d = Date.now() - ts;
  if (d < 60000) return 'just now';
  if (d < 3600000) return Math.floor(d / 60000) + 'm ago';
  if (d < 86400000) return Math.floor(d / 3600000) + 'h ago';
  return Math.floor(d / 86400000) + 'd ago';
}

function truncate(str, max) {
  if (!str || str.length <= max) return str || '';
  return str.slice(0, max - 1) + 'â€¦';
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function escapeAttr(text) {
  return text.replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

</script>
<script src="/lucide.min.js"></script>
<script>lucide.createIcons();</script>
</body>
</html>
