<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Security â€” Clawd Control</title>
  <style>
    .page-header { margin-bottom: 10px; }
    .page-header h1 { font-size: 1.9rem; }
    .subtitle { color: var(--text-secondary); font-size: 0.86rem; }

    /* â”€â”€ Overall Status Banner â”€â”€ */
    .overall-banner {
      border-radius: 10px;
      margin-bottom: 16px;
      padding: 6px 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      color: #fff;
      transition: background 0.3s;
    }
    .overall-banner.green { background: #27AE60; }
    .overall-banner.yellow { background: #D4881C; }
    .overall-banner.red { background: #C0392B; }
    .overall-banner.unknown { background: #636e72; }
    .overall-title { font-size: 0.82rem; font-weight: 700; }
    .overall-meta { font-size: 0.68rem; opacity: 0.92; margin-top: 1px; }
    .btn-recheck {
      border: 1px solid rgba(255,255,255,0.3);
      background: rgba(0,0,0,0.15);
      color: #fff;
      padding: 5px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.7rem;
      min-height: 30px;
      white-space: nowrap;
      transition: background 0.15s;
    }
    .btn-recheck:hover { background: rgba(0,0,0,0.3); }
    .btn-recheck:disabled { opacity: 0.6; cursor: wait; }

    /* â”€â”€ Tier Accordion â”€â”€ */
    .tier-accordions { display: grid; gap: 8px; margin-bottom: 16px; }

    .tier {
      border-radius: 10px;
      overflow: hidden;
      border: 1px solid var(--border);
      transition: border-color 0.3s;
    }
    .tier.tier-green { border-color: rgba(39,174,96,0.4); }
    .tier.tier-yellow { border-color: rgba(212,136,28,0.5); }
    .tier.tier-red { border-color: rgba(192,57,43,0.5); }

    /* â”€â”€ Tier Banner (clickable) â”€â”€ */
    .tier-banner {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      cursor: pointer;
      user-select: none;
      transition: background 0.2s;
      position: relative;
    }
    .tier-banner:hover { filter: brightness(1.08); }

    /* Tier status backgrounds */
    .tier.tier-green .tier-banner { background: rgba(39,174,96,0.12); }
    .tier.tier-yellow .tier-banner { background: rgba(212,136,28,0.14); }
    .tier.tier-red .tier-banner { background: rgba(192,57,43,0.14); }
    .tier.tier-unknown .tier-banner { background: rgba(99,110,114,0.12); }

    .tier-icon { font-size: 1.05rem; flex-shrink: 0; }
    .tier-info { flex: 1; min-width: 0; }
    .tier-name { font-weight: 700; font-size: 0.84rem; color: var(--text-primary); }
    .tier-desc { font-size: 0.68rem; color: var(--text-tertiary); margin-top: 1px; }

    .tier-summary {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-shrink: 0;
    }
    .tier-badge {
      font-size: 0.64rem;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 10px;
      white-space: nowrap;
    }
    .tier-badge.badge-green { background: rgba(39,174,96,0.2); color: #2ecc71; }
    .tier-badge.badge-yellow { background: rgba(212,136,28,0.2); color: #f0a836; }
    .tier-badge.badge-red { background: rgba(192,57,43,0.2); color: #e74c3c; }

    .tier-chevron {
      width: 18px; height: 18px;
      flex-shrink: 0;
      color: var(--text-tertiary);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .tier.open .tier-chevron { transform: rotate(180deg); }

    /* â”€â”€ Tier Body (collapsible) â”€â”€ */
    .tier-body {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.35s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .tier-body-inner {
      padding: 6px 10px 10px;
      display: grid;
      gap: 6px;
    }

    /* â”€â”€ Security Check Cards â”€â”€ */
    .check-card {
      border: 1px solid var(--border-subtle);
      border-radius: 8px;
      background: var(--bg-tertiary);
      overflow: hidden;
      transition: border-color 0.2s, background 0.2s;
    }
    .check-card.card-green { border-left: 3px solid #27AE60; }
    .check-card.card-yellow { border-left: 3px solid #D4881C; background: rgba(212,136,28,0.05); }
    .check-card.card-red { border-left: 3px solid #C0392B; background: rgba(192,57,43,0.06); }

    .check-row {
      padding: 8px 10px;
      display: flex;
      align-items: flex-start;
      gap: 8px;
    }
    .check-dot {
      width: 9px; height: 9px;
      border-radius: 50%;
      margin-top: 4px;
      flex-shrink: 0;
    }
    .check-dot.green { background: #27AE60; }
    .check-dot.yellow { background: #D4881C; }
    .check-dot.red { background: #C0392B; }
    .check-dot.unknown { background: #636e72; }

    .check-info { flex: 1; min-width: 0; }
    .check-top {
      display: flex;
      align-items: baseline;
      gap: 6px;
    }
    .check-name { font-weight: 600; font-size: 0.8rem; color: var(--text-primary); }
    .check-layer-tag {
      font-size: 0.58rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--text-tertiary);
      background: var(--surface);
      padding: 1px 5px;
      border-radius: 4px;
    }
    .check-msg { font-size: 0.74rem; color: var(--text-secondary); margin-top: 2px; line-height: 1.3; }
    .check-meta {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 3px;
    }
    .check-time { font-size: 0.64rem; color: var(--text-tertiary); }
    .check-expand-btn {
      background: none;
      border: none;
      color: var(--text-tertiary);
      font-size: 0.64rem;
      cursor: pointer;
      padding: 0;
      text-decoration: underline;
      text-underline-offset: 2px;
    }
    .check-expand-btn:hover { color: var(--text-secondary); }

    /* â”€â”€ Card Expandable â”€â”€ */
    .check-expand {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .check-expand-inner {
      padding: 0 10px 8px;
    }
    .check-details-box {
      font-family: var(--font-mono);
      font-size: 0.7rem;
      color: var(--text-secondary);
      white-space: pre-wrap;
      word-break: break-word;
      background: rgba(10,12,16,0.35);
      border-radius: 6px;
      padding: 5px 8px;
      margin-bottom: 6px;
    }
    .check-remediation {
      border-radius: 6px;
      padding: 6px 8px;
      font-size: 0.7rem;
      display: flex;
      align-items: flex-start;
      gap: 8px;
      flex-wrap: wrap;
    }
    .check-remediation.yellow { background: rgba(212,136,28,0.15); }
    .check-remediation.red { background: rgba(192,57,43,0.15); }
    .remediation-text { font-family: var(--font-mono); flex: 1; min-width: 140px; word-break: break-word; color: var(--text-secondary); }
    .remediation-actions { display: flex; gap: 6px; flex-shrink: 0; }
    .mini-btn {
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(10,12,16,0.3);
      color: #dfe6e9;
      border-radius: 5px;
      padding: 3px 8px;
      font-size: 0.64rem;
      min-height: 26px;
      cursor: pointer;
      transition: background 0.15s;
    }
    .mini-btn:hover { background: rgba(10,12,16,0.55); color: #fff; }
    .mini-btn:disabled { opacity: 0.5; cursor: wait; }

    /* â”€â”€ Timeline â”€â”€ */
    .timeline-section {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px 12px;
    }
    .timeline-title { font-size: 0.86rem; margin-bottom: 8px; font-weight: 700; }
    .timeline-list { display: grid; gap: 4px; }
    .tl-item {
      border: 1px solid var(--border-subtle);
      border-radius: 6px;
      padding: 5px 9px;
      background: var(--bg-tertiary);
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 4px 10px;
      font-size: 0.72rem;
    }
    .tl-time { color: var(--text-tertiary); font-size: 0.66rem; }
    .tl-layer { color: var(--text-secondary); font-weight: 500; }
    .tl-message { font-size: 0.7rem; color: var(--text-primary); width: 100%; }
    .tl-dot { width: 7px; height: 7px; border-radius: 50%; display: inline-block; }
    .tl-dot.green { background: #27AE60; }
    .tl-dot.yellow { background: #D4881C; }
    .tl-dot.red { background: #C0392B; }
    .tl-dot.unknown { background: #636e72; }
    .tl-arrow { display: inline-flex; align-items: center; gap: 3px; font-size: 0.66rem; color: var(--text-tertiary); }
    .muted { color: var(--text-tertiary); font-size: 0.76rem; padding: 4px 0; }

    @media (max-width: 640px) {
      .overall-banner { flex-direction: column; align-items: stretch; padding: 8px 12px; }
      .overall-banner .btn-recheck { width: 100%; min-height: 44px; }
      .tier-banner { padding: 10px 12px; }
      .tier-desc { display: none; }
      .mini-btn { min-height: 44px; padding: 8px 10px; font-size: 0.7rem; }
    }
  </style>
</head>
<body>
  <main class="main">
    <div class="page-header">
      <h1>Security</h1>
      <p class="subtitle">Defense-in-depth posture across 8 layers.</p>
    </div>

    <section id="overallBanner" class="overall-banner unknown">
      <div>
        <div id="overallTitle" class="overall-title">Security Status Unknown</div>
        <div id="overallMeta" class="overall-meta">Waiting for data...</div>
      </div>
      <button id="recheckBtn" class="btn-recheck" type="button">Run Check Now</button>
    </section>

    <div id="tierAccordions" class="tier-accordions"></div>

    <section class="timeline-section">
      <div class="timeline-title">Event Timeline</div>
      <div id="timelineList" class="timeline-list">
        <div class="muted">Loading...</div>
      </div>
    </section>
  </main>

  <script src="/layout.js"></script>
  <script>
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       DATA
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    const TIERS = [
      {
        id: 'infra', label: 'Infrastructure', icon: 'ğŸ›¡',
        desc: 'Network perimeter, brute-force protection, and mesh access',
        checks: [
          { name: 'UFW Firewall', key: 'network_firewall', tag: 'L1' },
          { name: 'fail2ban', key: 'network_brute_force', tag: 'L1' },
          { name: 'Tailscale', key: 'access', tag: 'L2' },
        ]
      },
      {
        id: 'app', label: 'Application Boundary', icon: 'ğŸ”’',
        desc: 'Public access, gateway bind, and channel policy',
        checks: [
          { name: 'Cloudflare Access', key: 'public', tag: 'L3' },
          { name: 'Gateway Bind', key: 'gateway', tag: 'L4' },
          { name: 'Channel Allowlist', key: 'channel', tag: 'L5' },
        ]
      },
      {
        id: 'agent', label: 'Agent', icon: 'ğŸ§ ',
        desc: 'Identity integrity, tool sandboxing, and memory security',
        checks: [
          { name: 'SOUL.md Integrity', key: 'reasoning', tag: 'L6' },
          { name: 'Tool Policy', key: 'operational', tag: 'L7' },
          { name: 'Memory Security', key: 'memory', tag: 'L8' },
        ]
      }
    ];

    const state = { health: null, transitions: [], pollTimer: null, running: false };
    const openTiers = new Set();    // track which tiers are expanded
    const openCards = new Set();    // track which card details are expanded
    const $ = id => document.getElementById(id);

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       HELPERS
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    function esc(v) {
      return String(v ?? '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    function relTime(iso) {
      if (!iso) return 'unknown';
      const m = Math.floor((Date.now() - new Date(iso).getTime()) / 60000);
      if (m < 1) return 'just now';
      if (m < 60) return `${m}m ago`;
      const h = Math.floor(m / 60);
      if (h < 24) return `${h}h ago`;
      return `${Math.floor(h / 24)}d ago`;
    }

    async function api(path, init = {}) {
      const res = await fetch(path, {
        cache: 'no-store', credentials: 'same-origin',
        headers: { 'Content-Type': 'application/json', ...(init.headers || {}) },
        ...init
      });
      if (!res.ok) throw new Error(`${res.status}`);
      return res.json();
    }

    function tok(raw, stale) {
      if (stale) return 'unknown';
      const s = String(raw || '').toLowerCase();
      if (['green','secure','ok','success'].includes(s)) return 'green';
      if (['yellow','warning','warn','degraded'].includes(s)) return 'yellow';
      if (['red','critical','error','failed'].includes(s)) return 'red';
      return 'unknown';
    }

    function worstStatus(statuses) {
      if (statuses.includes('red')) return 'red';
      if (statuses.includes('yellow')) return 'yellow';
      if (statuses.includes('unknown')) return 'unknown';
      return 'green';
    }

    const CHEVRON_SVG = `<svg class="tier-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>`;

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       OVERALL BANNER
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    function renderBanner() {
      const h = state.health || {};
      const checks = Array.isArray(h.checks) ? h.checks : [];
      const overall = tok(h.overall_status, h.stale);
      const bad = checks.filter(c => { const t = tok(c.status); return t === 'yellow' || t === 'red'; }).length;

      const banner = $('overallBanner');
      banner.className = `overall-banner ${overall}`;

      const titles = {
        green: 'All Systems Secure',
        yellow: 'Warnings Detected',
        red: 'Security Issues Detected',
        unknown: 'Security Status Unknown'
      };
      const metas = {
        green: h.generated_at ? `Checked ${relTime(h.generated_at)}` : '',
        yellow: `${bad} layer${bad !== 1 ? 's' : ''} need attention`,
        red: `${bad} layer${bad !== 1 ? 's' : ''} in warning or critical state`,
        unknown: 'Data stale or unavailable'
      };

      $('overallTitle').textContent = titles[overall];
      $('overallMeta').textContent = metas[overall];
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       TIER ACCORDIONS
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    function buildSummaryBadges(checks, byLayer, staleAll) {
      const counts = { green: 0, yellow: 0, red: 0 };
      checks.forEach(d => {
        const t = tok(byLayer[d.key]?.status, staleAll);
        if (t === 'green') counts.green++;
        else if (t === 'yellow') counts.yellow++;
        else if (t === 'red') counts.red++;
      });
      let html = '';
      if (counts.green) html += `<span class="tier-badge badge-green">${counts.green} secure</span>`;
      if (counts.yellow) html += `<span class="tier-badge badge-yellow">${counts.yellow} warning</span>`;
      if (counts.red) html += `<span class="tier-badge badge-red">${counts.red} critical</span>`;
      if (!html) html = `<span class="tier-badge" style="opacity:0.5">no data</span>`;
      return html;
    }

    function buildCardHTML(def, check, staleAll) {
      const t = tok(check?.status, staleAll);
      const rem = check?.remediation || '';
      const details = check?.details || 'No details available.';
      const expandId = `cexp-${def.key}`;
      const isOpen = openCards.has(def.key);

      const remBlock = (t === 'yellow' || t === 'red') && rem
        ? `<div class="check-remediation ${t}">
            <div class="remediation-text">${esc(rem)}</div>
            <div class="remediation-actions">
              <button class="mini-btn" type="button" data-action="copy" data-text="${esc(rem)}">Copy</button>
              ${def.key === 'reasoning' ? '<button class="mini-btn" data-action="ack" type="button">Acknowledge</button>' : ''}
            </div>
          </div>`
        : '';

      return `
        <div class="check-card card-${t}" data-layer="${def.key}">
          <div class="check-row">
            <span class="check-dot ${t}"></span>
            <div class="check-info">
              <div class="check-top">
                <span class="check-name">${esc(def.name)}</span>
                <span class="check-layer-tag">${esc(def.tag)}</span>
              </div>
              <div class="check-msg">${esc(check?.message || 'No data.')}</div>
              <div class="check-meta">
                <span class="check-time">${relTime(check?.checked_at)}</span>
                <button class="check-expand-btn" type="button" data-action="card-toggle" data-key="${def.key}" data-expand="${expandId}">${isOpen ? 'hide' : 'details'}</button>
              </div>
            </div>
          </div>
          <div id="${expandId}" class="check-expand" ${isOpen ? 'data-open="1"' : ''}>
            <div class="check-expand-inner">
              <div class="check-details-box">${esc(details)}</div>
              ${remBlock}
            </div>
          </div>
        </div>`;
    }

    function renderTiers() {
      const checks = Array.isArray(state.health?.checks) ? state.health.checks : [];
      const byLayer = Object.fromEntries(checks.map(c => [c.layer, c]));
      const staleAll = !!state.health?.stale;

      $('tierAccordions').innerHTML = TIERS.map(tier => {
        const tierStatuses = tier.checks.map(d => tok(byLayer[d.key]?.status, staleAll));
        const tierStatus = worstStatus(tierStatuses);
        const isOpen = openTiers.has(tier.id);

        return `
          <div class="tier tier-${tierStatus} ${isOpen ? 'open' : ''}" data-tier="${tier.id}">
            <div class="tier-banner" data-action="tier-toggle" data-tier="${tier.id}">
              <span class="tier-icon">${tier.icon}</span>
              <div class="tier-info">
                <div class="tier-name">${esc(tier.label)}</div>
                <div class="tier-desc">${esc(tier.desc)}</div>
              </div>
              <div class="tier-summary">
                ${buildSummaryBadges(tier.checks, byLayer, staleAll)}
              </div>
              ${CHEVRON_SVG}
            </div>
            <div class="tier-body" id="tbody-${tier.id}" ${isOpen ? 'data-open="1"' : ''}>
              <div class="tier-body-inner">
                ${tier.checks.map(d => buildCardHTML(d, byLayer[d.key], staleAll)).join('')}
              </div>
            </div>
          </div>`;
      }).join('');

      // Restore open states after render
      requestAnimationFrame(() => {
        openTiers.forEach(id => {
          const body = $(`tbody-${id}`);
          if (body) body.style.maxHeight = body.scrollHeight + 'px';
        });
        openCards.forEach(key => {
          const el = $(`cexp-${key}`);
          if (el) el.style.maxHeight = el.scrollHeight + 'px';
        });
      });
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       TIMELINE
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    function renderTimeline() {
      const entries = state.transitions || [];
      if (!entries.length) {
        $('timelineList').innerHTML = '<div class="muted">No status changes recorded yet.</div>';
        return;
      }
      $('timelineList').innerHTML = entries.map(e => {
        const from = tok(e.old_status);
        const to = tok(e.new_status);
        return `<div class="tl-item">
          <span class="tl-time">${relTime(e.checked_at || e.timestamp)}</span>
          <span class="tl-layer">${esc(e.name || e.layer)}</span>
          <span class="tl-arrow">
            <span class="tl-dot ${from}"></span> ${from}
            <span style="opacity:0.4">â†’</span>
            <span class="tl-dot ${to}"></span> ${to}
          </span>
          <span class="tl-message">${esc(e.message || '')}</span>
        </div>`;
      }).join('');
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       DATA LOADING
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    async function loadHealth() {
      try { state.health = await api('/api/security/health'); }
      catch { state.health = { overall_status: 'unknown', checks: [], stale: true }; }
      renderBanner();
      renderTiers();
      if (window.refreshSecurityBadge) window.refreshSecurityBadge();
    }

    async function loadTransitions() {
      try {
        const data = await api('/api/security/transitions?limit=20');
        state.transitions = Array.isArray(data) ? data : [];
      } catch { state.transitions = []; }
      renderTimeline();
    }

    async function refresh() { await Promise.all([loadHealth(), loadTransitions()]); }

    async function runCheckNow() {
      if (state.running) return;
      state.running = true;
      const btn = $('recheckBtn');
      btn.disabled = true; btn.textContent = 'Checking...';
      try { state.health = await api('/api/security/recheck', { method: 'POST', body: '{}' }); } catch {}
      btn.disabled = false; btn.textContent = 'Run Check Now'; state.running = false;
      await refresh();
    }

    async function acknowledgeReasoning() {
      try {
        await api('/api/security/acknowledge', {
          method: 'POST',
          body: JSON.stringify({ layer: 'reasoning', note: 'Approved from dashboard' })
        });
        await runCheckNow();
      } catch (e) {
        if (window.showToast) window.showToast(`Acknowledge failed: ${e.message}`, 'error');
      }
    }

    async function copyText(text) {
      if (!text?.trim()) return;
      try { await navigator.clipboard.writeText(text.trim()); }
      catch {
        const t = document.createElement('textarea');
        t.value = text.trim(); t.style.cssText = 'position:fixed;opacity:0';
        document.body.appendChild(t); t.select(); document.execCommand('copy'); t.remove();
      }
      if (window.showToast) window.showToast('Copied', 'success');
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       INTERACTIONS
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    function toggleTier(tierId) {
      const body = $(`tbody-${tierId}`);
      const tier = body?.closest('.tier');
      if (!body || !tier) return;

      if (openTiers.has(tierId)) {
        openTiers.delete(tierId);
        body.style.maxHeight = '0';
        tier.classList.remove('open');
      } else {
        openTiers.add(tierId);
        body.style.maxHeight = body.scrollHeight + 'px';
        tier.classList.add('open');
      }
    }

    function toggleCard(key, expandId) {
      const el = $(expandId);
      if (!el) return;

      if (openCards.has(key)) {
        openCards.delete(key);
        el.style.maxHeight = '0';
      } else {
        openCards.add(key);
        el.style.maxHeight = el.scrollHeight + 'px';
      }
    }

    function bindEvents() {
      $('recheckBtn').onclick = runCheckNow;

      $('tierAccordions').onclick = async (e) => {
        // Tier toggle
        const tierBanner = e.target.closest('[data-action="tier-toggle"]');
        if (tierBanner) {
          toggleTier(tierBanner.dataset.tier);
          return;
        }

        // Button actions inside cards
        const btn = e.target.closest('button[data-action]');
        if (!btn) return;
        const action = btn.dataset.action;

        if (action === 'card-toggle') {
          toggleCard(btn.dataset.key, btn.dataset.expand);
          btn.textContent = openCards.has(btn.dataset.key) ? 'hide' : 'details';
          return;
        }
        if (action === 'copy') { await copyText(btn.dataset.text); return; }
        if (action === 'ack') { btn.disabled = true; await acknowledgeReasoning(); btn.disabled = false; return; }
      };
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       LIFECYCLE
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    function startPolling() {
      if (state.pollTimer) clearInterval(state.pollTimer);
      state.pollTimer = setInterval(() => refresh(), 60000);
    }

    function cleanupSecurityTab() {
      if (state.pollTimer) { clearInterval(state.pollTimer); state.pollTimer = null; }
      window.__securityInitRoot = null;
    }

    async function initSecurityTab() {
      const root = $('tierAccordions');
      if (!root) return;
      if (window.__securityInitRoot === root && state.pollTimer) return;
      window.__securityInitRoot = root;

      // Auto-expand tiers that have warnings/issues on first load
      openTiers.clear();
      openCards.clear();

      bindEvents();
      await refresh();

      // After first load, auto-expand degraded tiers
      if (state.health && !state.health.stale) {
        const checks = state.health.checks || [];
        const byLayer = Object.fromEntries(checks.map(c => [c.layer, c]));
        TIERS.forEach(tier => {
          const hasIssue = tier.checks.some(d => {
            const t = tok(byLayer[d.key]?.status);
            return t === 'yellow' || t === 'red';
          });
          if (hasIssue) {
            openTiers.add(tier.id);
            const body = $(`tbody-${tier.id}`);
            const tierEl = body?.closest('.tier');
            if (body) { body.style.maxHeight = body.scrollHeight + 'px'; }
            if (tierEl) { tierEl.classList.add('open'); }
          }
        });
      }

      startPolling();
    }

    window.cleanupSecurityTab = cleanupSecurityTab;
    window.initSecurityTab = initSecurityTab;

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => initSecurityTab());
    } else {
      initSecurityTab();
    }
  </script>
</body>
</html>
