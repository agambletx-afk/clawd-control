<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Costs â€” Clawd Control</title>
</head>
<body>
    <main class="main">
        <div class="page-header">
            <h1>ðŸ“Š Costs</h1>
            <p class="subtitle">Operational expenditures and API usage</p>
        </div>

        <section class="card-grid-2">
            <div class="card">
                <h2 class="card-title">Gemini Flash Quota</h2>
                <div class="quota-tracker">
                    <div class="quota-bar-container">
                        <div class="quota-label">Requests Today: <span id="rpdUsed">--</span> / <span id="rpdLimit">--</span> (<span id="rpdPercent">--%</span>)</div>
                        <div class="quota-bar" id="rpdBar"></div>
                    </div>
                    <div class="quota-bar-container">
                        <div class="quota-label">Requests This Minute: <span id="rpmUsed">--</span> / <span id="rpmLimit">--</span> (<span id="rpmPercent">--%</span>)</div>
                        <div class="quota-bar" id="rpmBar"></div>
                    </div>
                </div>
            </div>
        </section>

        <section class="card-grid-1">
            <div class="card">
                <h2 class="card-title">Daily Spend</h2>
                <div class="chart-container" id="dailySpendChart">
                    <div class="chart-y-axis"></div>
                    <div class="chart-bars"></div>
                </div>
            </div>
        </section>

        <section class="card-grid-1">
            <div class="card">
                <h2 class="card-title">Per-Session Costs</h2>
                <table class="data-table" id="sessionCostTable">
                    <thead>
                        <tr>
                            <th>Session ID</th>
                            <th>Started</th>
                            <th>Model</th>
                            <th>Messages</th>
                            <th>Tokens</th>
                            <th>Cost</th>
                            <th>Source</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data will be injected here -->
                    </tbody>
                </table>
            </div>
        </section>

        <section class="card-grid-1">
            <div class="card">
                <h2 class="card-title">Per-Model Spend</h2>
                <div class="donut-chart-container">
                    <div class="donut-chart" id="modelSpendDonut"></div>
                    <div class="donut-legend" id="modelSpendLegend"></div>
                </div>
            </div>
        </section>

        <style>
            .page-header { margin-bottom: 24px; }
            .page-header h1 { font-size: 2.2rem; margin-bottom: 8px; color: var(--text-primary); }
            .page-header .subtitle { font-size: 0.95rem; color: var(--text-secondary); }

            .card-grid-1 { display: grid; grid-template-columns: 1fr; gap: 20px; margin-bottom: 20px; }
            .card-grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
            .card {
                background: var(--bg-secondary);
                border: 1px solid var(--border);
                border-radius: var(--radius-lg);
                padding: 24px;
                box-shadow: var(--shadow-sm);
            }
            .card-title { font-size: 1.25rem; font-weight: 600; margin-bottom: 20px; color: var(--text-primary); }

            /* Quota Tracker */
            .quota-tracker { display: flex; flex-direction: column; gap: 20px; }
            .quota-bar-container { display: flex; flex-direction: column; gap: 8px; }
            .quota-label { font-size: 0.9rem; color: var(--text-secondary); display: flex; justify-content: space-between; align-items: center; }
            .quota-bar {
                width: 100%; height: 10px; border-radius: 5px; background: var(--border-subtle);
                overflow: hidden; position: relative;
            }
            .quota-bar::before {
                content: ''; position: absolute; top: 0; left: 0; height: 100%; width: 0%;
                border-radius: 5px; background: var(--success); transition: width 0.3s ease-out, background-color 0.3s ease-out;
            }
            .quota-bar[data-percent^="6"]::before, .quota-bar[data-percent^="7"]::before { background: var(--warning); }
            .quota-bar[data-percent^="8"]::before, .quota-bar[data-percent^="9"]::before, .quota-bar[data-percent="100"]::before { background: var(--error); }


            /* Daily Spend Chart (CSS only) */
            .chart-container {
                display: flex; height: 200px; /* Fixed height for the chart */
                align-items: flex-end; gap: 4px;
                padding: 0 10px;
                position: relative;
            }
            .chart-y-axis {
                position: absolute; left: 0; top: 0; bottom: 0; width: 40px;
                display: flex; flex-direction: column-reverse; justify-content: space-between;
                font-size: 0.7rem; color: var(--text-tertiary);
                padding: 5px 0;
            }
            .chart-y-axis div {
                position: relative;
                height: 1px; /* Divider line */
                border-bottom: 1px dashed var(--border-subtle);
                width: calc(100% + 10px); /* Extend beyond y-axis label */
                margin-left: -10px;
                text-align: right;
                padding-right: 15px;
            }
            .chart-y-axis div:first-child { border-bottom: none; }
            .chart-bars {
                display: flex; flex: 1; height: 100%; align-items: flex-end; gap: 2px;
                position: relative; /* For tooltips */
            }
            .chart-bar {
                flex: 1; background: var(--accent); border-radius: 3px 3px 0 0;
                position: relative; cursor: pointer; transition: background 0.2s ease-out;
                min-width: 10px; /* Prevent bars from becoming too thin */
            }
            .chart-bar:hover { background: var(--accent-hover); }
            .chart-bar-tooltip {
                position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
                background: var(--bg-tertiary); border: 1px solid var(--border);
                padding: 6px 10px; border-radius: var(--radius-sm);
                white-space: nowrap; font-size: 0.8rem;
                opacity: 0; pointer-events: none; transition: opacity 0.2s ease-out;
                margin-bottom: 5px;
            }
            .chart-bar:hover .chart-bar-tooltip { opacity: 1; }
            .chart-x-axis {
                position: absolute; bottom: -20px; left: 0; right: 0;
                display: flex; justify-content: space-between;
                font-size: 0.7rem; color: var(--text-tertiary);
                padding: 0 10px;
            }
            .chart-x-axis div {
                flex: 1; text-align: center;
            }


            /* Data Table */
            .data-table {
                width: 100%; border-collapse: collapse; font-size: 0.85rem;
                background: var(--bg-secondary);
                border: 1px solid var(--border);
                border-radius: var(--radius-md);
                overflow: hidden;
            }
            .data-table th, .data-table td {
                padding: 12px 18px; text-align: left;
                border-bottom: 1px solid var(--border-subtle);
            }
            .data-table th {
                background: var(--surface); color: var(--text-primary);
                font-weight: 600; text-transform: uppercase; font-size: 0.75rem;
                letter-spacing: 0.05em; cursor: pointer;
            }
            .data-table th:hover { background: var(--surface-hover); }
            .data-table tbody tr:last-child td { border-bottom: none; }
            .data-table tbody tr:nth-child(even) { background: var(--bg-tertiary); }
            .data-table tbody tr:hover { background: var(--surface-hover); }
            .data-table tbody tr.highlight-red { background: var(--error-bg); }
            .data-table tbody tr.highlight-red td { color: var(--error); }


            /* Donut Chart */
            .donut-chart-container {
                display: flex; align-items: center; justify-content: center;
                gap: 40px; margin-top: 20px;
            }
            .donut-chart {
                width: 150px; height: 150px; border-radius: 50%;
                background: conic-gradient(var(--border-subtle) 0 100%);
                position: relative;
                display: flex; align-items: center; justify-content: center;
            }
            .donut-chart::before {
                content: ''; position: absolute; background: var(--bg-secondary);
                width: 100px; height: 100px; border-radius: 50%;
            }
            .donut-legend {
                display: flex; flex-direction: column; gap: 8px;
            }
            .donut-legend-item {
                display: flex; align-items: center; gap: 8px;
                font-size: 0.9rem; color: var(--text-secondary);
            }
            .donut-legend-color {
                width: 12px; height: 12px; border-radius: 3px;
                flex-shrink: 0;
            }
        </style>

        <script>
            // Data loading and rendering logic will go here
            document.addEventListener('DOMContentLoaded', () => {
                // Function to fetch and update quota data
                async function updateQuota() {
                    try {
                        const response = await fetch('/api/costs/quota');
                        const data = await response.json();

                        // RPD
                        const rpdUsed = data.rpd.used;
                        const rpdLimit = data.rpd.limit;
                        const rpdPercent = ((rpdUsed / rpdLimit) * 100).toFixed(0);
                        document.getElementById('rpdUsed').textContent = rpdUsed;
                        document.getElementById('rpdLimit').textContent = rpdLimit;
                        document.getElementById('rpdPercent').textContent = rpdPercent;
                        document.getElementById('rpdBar').style.setProperty('--width', `${rpdPercent}%`);
                        document.getElementById('rpdBar').setAttribute('data-percent', rpdPercent);


                        // RPM
                        const rpmUsed = data.rpm.used;
                        const rpmLimit = data.rpm.limit;
                        const rpmPercent = ((rpmUsed / rpmLimit) * 100).toFixed(0);
                        document.getElementById('rpmUsed').textContent = rpmUsed;
                        document.getElementById('rpmLimit').textContent = rpmLimit;
                        document.getElementById('rpmPercent').textContent = rpmPercent;
                        document.getElementById('rpmBar').style.setProperty('--width', `${rpmPercent}%`);
                        document.getElementById('rpmBar').setAttribute('data-percent', rpmPercent);

                        document.getElementById('rpdBar').style.width = `${rpdPercent}%`;
                        document.getElementById('rpmBar').style.width = `${rpmPercent}%`;

                    } catch (error) {
                        console.error('Failed to fetch quota data:', error);
                    }
                }

                // Initial fetch and update
                updateQuota();

                // Set up SSE for live updates (already handled by layout.js 'layout:snapshot' event)
                document.addEventListener('layout:snapshot', updateQuota);


                // Placeholder for other charts and tables
                async function loadCostData() {
                    try {
                        const dailyResponse = await fetch('/api/costs/daily');
                        const dailyData = await dailyResponse.json();
                        renderDailySpendChart(dailyData);

                        const sessionResponse = await fetch('/api/costs/sessions');
                        const sessionData = await sessionResponse.json();
                        renderSessionCostTable(sessionData);

                        const modelResponse = await fetch('/api/costs/daily'); // Reuse daily for model data structure
                        const modelData = await modelResponse.json();
                        renderModelSpendDonut(modelData);


                    } catch (error) {
                        console.error('Failed to load cost data:', error);
                    }
                }

                function renderDailySpendChart(data) {
                    const chartBars = document.querySelector('#dailySpendChart .chart-bars');
                    const chartYAxis = document.querySelector('#dailySpendChart .chart-y-axis');
                    chartBars.innerHTML = '';
                    chartYAxis.innerHTML = '';

                    if (data.length === 0) {
                        chartBars.textContent = 'No data available.';
                        return;
                    }

                    const maxSpend = Math.max(...data.map(d => d.total));
                    const numYAxisLabels = 4; // Example: 0, 25%, 50%, 75%, Max
                    for (let i = 0; i <= numYAxisLabels; i++) {
                        const labelValue = (maxSpend / numYAxisLabels * i).toFixed(2);
                        const labelDiv = document.createElement('div');
                        labelDiv.textContent = `$${labelValue}`;
                        chartYAxis.appendChild(labelDiv);
                    }

                    data.forEach(item => {
                        const bar = document.createElement('div');
                        bar.className = 'chart-bar';
                        const height = (item.total / maxSpend) * 100; // Height as percentage of max
                        bar.style.height = `${height}%`;
                        bar.title = `${item.date}: $${item.total.toFixed(2)}`; // Tooltip
                        chartBars.appendChild(bar);
                    });
                }


                function renderSessionCostTable(data) {
                    const tableBody = document.querySelector('#sessionCostTable tbody');
                    tableBody.innerHTML = '';

                    data.sort((a, b) => new Date(b.started) - new Date(a.started)); // Sort by most recent first

                    data.forEach(session => {
                        const row = tableBody.insertRow();
                        if (session.cost > 0.50) {
                            row.classList.add('highlight-red');
                        }
                        row.insertCell().textContent = session.id.substring(0, 8);
                        row.insertCell().textContent = new Date(session.started).toLocaleString();
                        row.insertCell().textContent = session.model;
                        row.insertCell().textContent = session.messages;
                        row.insertCell().textContent = session.tokens;
                        row.insertCell().textContent = `$${session.cost.toFixed(4)}`;
                        row.insertCell().textContent = session.source;
                    });
                }


                function renderModelSpendDonut(data) {
                    const donutChart = document.getElementById('modelSpendDonut');
                    const donutLegend = document.getElementById('modelSpendLegend');
                    donutChart.innerHTML = '';
                    donutLegend.innerHTML = '';

                    const modelCosts = {};
                    data.forEach(day => {
                        for (const modelId in day.byModel) {
                            if (modelCosts[modelId]) {
                                modelCosts[modelId] += day.byModel[modelId];
                            } else {
                                modelCosts[modelId] = day.byModel[modelId];
                            }
                        }
                    });

                    const totalCost = Object.values(modelCosts).reduce((sum, cost) => sum + cost, 0);
                    if (totalCost === 0) {
                        donutChart.textContent = 'No data';
                        donutChart.style.background = 'var(--border-subtle)';
                        return;
                    }

                    let currentAngle = 0;
                    const colors = ['#c9a44a', '#8a6b22', '#6b571c', '#4d3d13', '#2e240a']; // Example colors
                    let colorIndex = 0;
                    let conicGradient = 'conic-gradient(';

                    for (const modelId in modelCosts) {
                        const cost = modelCosts[modelId];
                        const percentage = (cost / totalCost) * 100;
                        const angle = (cost / totalCost) * 360;

                        const color = colors[colorIndex % colors.length];
                        conicGradient += `${color} ${currentAngle}deg ${currentAngle + angle}deg, `;
                        currentAngle += angle;

                        const legendItem = document.createElement('div');
                        legendItem.className = 'donut-legend-item';
                        legendItem.innerHTML = `<div class="donut-legend-color" style="background:${color};"></div><span>${modelId} (${percentage.toFixed(1)}%)</span>`;
                        donutLegend.appendChild(legendItem);
                        colorIndex++;
                    }

                    conicGradient = conicGradient.slice(0, -2) + ')'; // Remove trailing comma and space, close gradient
                    donutChart.style.background = conicGradient;
                }

                loadCostData();
            });
        </script>
    </main>
</body>
</html>
